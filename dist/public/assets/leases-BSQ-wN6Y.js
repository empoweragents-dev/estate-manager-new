import{r as g,o as ie,u as le,e as k,x as de,j as e,S as F,C as V,a as _,m as l,D as $,p as ve,P as z,q as H,s as U,t as X,K as o,av as be,I as v,a7 as we,Y as Se,Z as De,_ as Y,$ as y,a0 as Ce,a1 as N,X as G,ax as Ie,L as J,h as Fe,al as oe,l as Te,k as qe,aK as Le,aw as ke,z as c,v as Ee,w as Ke,F as Be,y as x,A as u,E as h,a8 as W,G as p,a9 as Z,aa as ee,ab as se,ac as te,H as j,am as Oe,n as Pe,J as ce}from"./index-BFK3BxsS.js";import{T as Ae,a as Qe,b as T}from"./tabs-UU6nYvMW.js";import{U as ae,B as ne}from"./upload-DbQ55AW6.js";import{F as re}from"./file-spreadsheet-DB5OvRJ7.js";import{D as Re}from"./download-B_ULuPrt.js";import{T as O}from"./triangle-alert-Di3FTKlq.js";const Me=c.object({tenantId:c.string().min(1,"Tenant is required"),shopId:c.string().min(1,"Shop is required"),startDate:c.string().min(1,"Start date is required"),endDate:c.string().min(1,"End date is required"),securityDeposit:c.string().min(1,"Security deposit is required"),monthlyRent:c.string().min(1,"Monthly rent is required"),openingDueBalance:c.string().default("0"),notes:c.string().optional()});function Ve({tenants:E,shops:S,onSuccess:K}){const{toast:f}=ie();le();const m=S.filter(t=>t.status==="vacant"),a=Ee({resolver:Ke(Me),defaultValues:{tenantId:"",shopId:"",startDate:new Date().toISOString().split("T")[0],endDate:"",securityDeposit:"",monthlyRent:"",openingDueBalance:"0",notes:""}}),b=de({mutationFn:async t=>ce("POST","/api/leases",{tenantId:parseInt(t.tenantId),shopId:parseInt(t.shopId),startDate:t.startDate,endDate:t.endDate,securityDeposit:t.securityDeposit,monthlyRent:t.monthlyRent,openingDueBalance:t.openingDueBalance,notes:t.notes}),onSuccess:()=>{o.invalidateQueries({queryKey:["/api/leases"]}),o.invalidateQueries({queryKey:["/api/shops"]}),f({title:"Lease created successfully"}),K()},onError:t=>{f({title:"Error",description:t.message,variant:"destructive"})}}),q=t=>{b.mutate(t)};return e.jsx(Be,{...a,children:e.jsxs("form",{onSubmit:a.handleSubmit(q),className:"space-y-4",children:[e.jsx(x,{control:a.control,name:"tenantId",render:({field:t})=>e.jsxs(u,{children:[e.jsx(h,{children:"Tenant *"}),e.jsxs(W,{onValueChange:t.onChange,defaultValue:t.value,children:[e.jsx(p,{children:e.jsx(Z,{"data-testid":"select-lease-tenant",children:e.jsx(ee,{placeholder:"Select tenant"})})}),e.jsx(se,{children:E.map(n=>e.jsxs(te,{value:n.id.toString(),children:[n.name," - ",n.phone]},n.id))})]}),e.jsx(j,{})]})}),e.jsx(x,{control:a.control,name:"shopId",render:({field:t})=>e.jsxs(u,{children:[e.jsx(h,{children:"Shop *"}),e.jsxs(W,{onValueChange:t.onChange,defaultValue:t.value,children:[e.jsx(p,{children:e.jsx(Z,{"data-testid":"select-lease-shop",children:e.jsx(ee,{placeholder:"Select shop"})})}),e.jsx(se,{children:m.length>0?m.map(n=>e.jsxs(te,{value:n.id.toString(),children:["Shop ",n.shopNumber," - ",oe(n.floor),n.squareFeet&&` (${n.squareFeet} sq ft)`]},n.id)):e.jsx("div",{className:"px-2 py-1.5 text-sm text-muted-foreground",children:"No vacant shops available"})})]}),e.jsx(j,{})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(x,{control:a.control,name:"startDate",render:({field:t})=>e.jsxs(u,{children:[e.jsx(h,{children:"Start Date *"}),e.jsx(p,{children:e.jsx(v,{...t,type:"date","data-testid":"input-lease-start"})}),e.jsx(j,{})]})}),e.jsx(x,{control:a.control,name:"endDate",render:({field:t})=>e.jsxs(u,{children:[e.jsx(h,{children:"End Date *"}),e.jsx(p,{children:e.jsx(v,{...t,type:"date","data-testid":"input-lease-end"})}),e.jsx(j,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(x,{control:a.control,name:"securityDeposit",render:({field:t})=>e.jsxs(u,{children:[e.jsx(h,{children:"Security Deposit (BDT) *"}),e.jsx(p,{children:e.jsx(v,{...t,type:"number",step:"0.01",placeholder:"Advance amount","data-testid":"input-lease-deposit"})}),e.jsx(j,{})]})}),e.jsx(x,{control:a.control,name:"monthlyRent",render:({field:t})=>e.jsxs(u,{children:[e.jsx(h,{children:"Monthly Rent (BDT) *"}),e.jsx(p,{children:e.jsx(v,{...t,type:"number",step:"0.01",placeholder:"Monthly rent amount","data-testid":"input-lease-rent"})}),e.jsx(j,{})]})})]}),e.jsx("div",{className:"border-2 border-amber-500/50 bg-amber-50 dark:bg-amber-900/20 rounded-lg p-4",children:e.jsx(x,{control:a.control,name:"openingDueBalance",render:({field:t})=>e.jsxs(u,{children:[e.jsxs(h,{className:"flex items-center gap-2 text-amber-700 dark:text-amber-400",children:[e.jsx(O,{className:"h-4 w-4"}),"Opening Due Balance (BDT)"]}),e.jsx(p,{children:e.jsx(v,{...t,type:"number",step:"0.01",placeholder:"0.00",className:"text-lg font-semibold","data-testid":"input-lease-opening-balance"})}),e.jsx(Oe,{className:"text-amber-600 dark:text-amber-500",children:"Enter any pre-existing debt for this specific shop/lease from before using this system."}),e.jsx(j,{})]})})}),e.jsx(x,{control:a.control,name:"notes",render:({field:t})=>e.jsxs(u,{children:[e.jsx(h,{children:"Notes"}),e.jsx(p,{children:e.jsx(v,{...t,placeholder:"Additional notes","data-testid":"input-lease-notes"})}),e.jsx(j,{})]})}),e.jsx("div",{className:"flex justify-end gap-2 pt-4",children:e.jsx(l,{type:"submit",disabled:b.isPending,"data-testid":"button-save-lease",children:b.isPending?"Creating...":"Create Lease"})})]})})}function Ye(){var M;const[E,S]=g.useState(!1),[K,f]=g.useState(!1),[m,a]=g.useState(null),[b,q]=g.useState(!1),[t,n]=g.useState("all"),[d,P]=g.useState(null),[L,A]=g.useState(""),{toast:D}=ie();le();const{data:me=[],isLoading:xe}=k({queryKey:["/api/leases"]}),{data:ue=[]}=k({queryKey:["/api/tenants"]}),{data:he=[]}=k({queryKey:["/api/shops"]}),{data:Q=[]}=k({queryKey:["/api/owners"]});de({mutationFn:async s=>ce("PATCH",`/api/leases/${s}/terminate`),onSuccess:()=>{o.invalidateQueries({queryKey:["/api/leases"]}),o.invalidateQueries({queryKey:["/api/shops"]}),D({title:"Lease terminated successfully"})},onError:s=>{D({title:"Error",description:s.message,variant:"destructive"})}});const pe=()=>{S(!1)},je=s=>{const r=typeof s=="string"?parseFloat(s)||0:s;return Pe(r)},fe=s=>{var r,i,I;if(d!==null&&(!s.shop||s.shop.ownerId!==d))return!1;if(L.trim()){const B=L.toLowerCase().trim(),ge=(((r=s.tenant)==null?void 0:r.name)||"").toLowerCase(),ye=(((i=s.shop)==null?void 0:i.shopNumber)||"").toLowerCase(),Ne=(((I=s.tenant)==null?void 0:I.businessName)||"").toLowerCase();if(!ge.includes(B)&&!ye.includes(B)&&!Ne.includes(B))return!1}return!0},w=me.filter(fe),R=w.filter(s=>!(t!=="all"&&s.status!==t)),C={all:w.length,active:w.filter(s=>s.status==="active").length,expiring_soon:w.filter(s=>s.status==="expiring_soon").length,expired:w.filter(s=>s.status==="expired").length,terminated:w.filter(s=>s.status==="terminated").length};return xe?e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(F,{className:"h-8 w-40"}),e.jsx(F,{className:"h-4 w-60 mt-2"})]}),e.jsx(F,{className:"h-9 w-32"})]}),e.jsx(F,{className:"h-10 w-96"}),e.jsx(V,{children:e.jsx(_,{className:"p-0",children:[1,2,3,4,5].map(s=>e.jsx(F,{className:"h-16 w-full"},s))})})]}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Leases"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage lease agreements and track expiration dates"})]}),e.jsxs("div",{className:"flex gap-2",children:[d&&e.jsxs(l,{variant:"outline",onClick:()=>f(!0),children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Import Payments"]}),e.jsxs($,{open:E,onOpenChange:S,children:[e.jsx(ve,{asChild:!0,children:e.jsxs(l,{"data-testid":"button-add-lease",children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"New Lease"]})}),e.jsxs(H,{className:"sm:max-w-lg",children:[e.jsx(U,{children:e.jsx(X,{children:"Create New Lease"})}),e.jsx(Ve,{tenants:ue,shops:he,onSuccess:pe})]})]})]})]}),e.jsx($,{open:K,onOpenChange:s=>{f(s),s||a(null)},children:e.jsxs(H,{className:"sm:max-w-lg",children:[e.jsx(U,{children:e.jsxs(X,{className:"flex items-center gap-2",children:[e.jsx(re,{className:"h-5 w-5"}),"Import Payment Collection for ",(M=Q.find(s=>s.id===d))==null?void 0:M.name]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Download the pre-filled template with tenant data and due months, fill in payment details, then upload to record payments in bulk."}),e.jsxs("div",{className:"bg-muted/50 p-3 rounded-lg text-sm space-y-1",children:[e.jsx("p",{className:"font-medium",children:"Template includes (pre-filled):"}),e.jsxs("ul",{className:"list-disc list-inside text-muted-foreground text-xs space-y-0.5",children:[e.jsx("li",{children:"Tenant Name, Lease ID, Shop Location"}),e.jsx("li",{children:"Monthly Rent, Due Month, Due Amount"})]}),e.jsx("p",{className:"font-medium mt-2",children:"You fill in:"}),e.jsxs("ul",{className:"list-disc list-inside text-muted-foreground text-xs space-y-0.5",children:[e.jsx("li",{children:"Payment Amount, Payment Date"}),e.jsx("li",{children:"For Month (which month the payment is for)"}),e.jsx("li",{children:"Notes (optional)"})]})]}),e.jsxs(l,{variant:"outline",size:"sm",className:"w-full",onClick:()=>{d&&window.open(`/api/owners/${d}/payment-template`,"_blank")},children:[e.jsx(Re,{className:"h-4 w-4 mr-2"}),"Download Pre-filled Template"]}),e.jsxs("label",{className:"border-2 border-dashed rounded-lg p-6 text-center cursor-pointer hover:border-primary transition-colors block",children:[e.jsx("input",{type:"file",className:"hidden",accept:".xlsx,.xls,.csv",onChange:s=>{var i;const r=(i=s.target.files)==null?void 0:i[0];r&&a(r)}}),m?e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"h-10 w-10 mx-auto text-primary"}),e.jsx("p",{className:"text-sm font-medium mt-2",children:m.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Click to choose a different file"})]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"h-10 w-10 mx-auto text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Click to upload filled template"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Excel (.xlsx, .xls) or CSV files"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"For multiple payments per tenant, add extra rows with the same Lease ID but different amounts/dates."}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(l,{variant:"outline",onClick:()=>f(!1),children:"Cancel"}),e.jsx(l,{disabled:!m||b,onClick:async()=>{if(!(!m||!d)){q(!0);try{const s=new FormData;s.append("file",m),s.append("ownerId",d.toString());const r=await fetch("/api/payments/bulk-import",{method:"POST",body:s,credentials:"include"}),i=await r.json();r.ok?(D({title:"Import Completed",description:i.message}),o.invalidateQueries({queryKey:["/api/leases"]}),o.invalidateQueries({queryKey:["/api/payments"]}),o.invalidateQueries({queryKey:["/api/rent-invoices"]}),o.invalidateQueries({queryKey:["/api/tenants"]}),o.invalidateQueries({queryKey:["/api/dashboard/stats"]}),o.invalidateQueries({queryKey:["/api/owners"]}),f(!1),a(null)):D({title:"Import Failed",description:i.message,variant:"destructive"})}catch(s){D({title:"Error",description:s.message||"Failed to import payments",variant:"destructive"})}finally{q(!1)}}},children:b?"Importing...":"Import Payments"})]})]})]})}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs(l,{variant:d===null?"default":"outline",size:"sm",onClick:()=>P(null),className:"flex items-center gap-1.5",children:[e.jsx(ne,{className:"h-3.5 w-3.5"}),"All Owners"]}),Q.map(s=>e.jsxs(l,{variant:d===s.id?"default":"outline",size:"sm",onClick:()=>P(s.id),className:"flex items-center gap-1.5",children:[e.jsx(ne,{className:"h-3.5 w-3.5"}),s.name]},s.id))]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center gap-4",children:[e.jsx(Ae,{value:t,onValueChange:n,className:"flex-1",children:e.jsxs(Qe,{children:[e.jsxs(T,{value:"all","data-testid":"tab-all-leases",children:["All (",C.all,")"]}),e.jsxs(T,{value:"active","data-testid":"tab-active-leases",children:["Active (",C.active,")"]}),e.jsxs(T,{value:"expiring_soon","data-testid":"tab-expiring-leases",children:[e.jsx(O,{className:"h-3 w-3 mr-1"}),"Expiring Soon (",C.expiring_soon,")"]}),e.jsxs(T,{value:"expired","data-testid":"tab-expired-leases",children:["Expired (",C.expired,")"]}),e.jsxs(T,{value:"terminated","data-testid":"tab-terminated-leases",children:["Terminated (",C.terminated,")"]})]})}),e.jsxs("div",{className:"relative w-full md:w-64",children:[e.jsx(be,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(v,{placeholder:"Search tenant, shop, business...",value:L,onChange:s=>A(s.target.value),className:"pl-10"}),L&&e.jsx(l,{variant:"ghost",size:"icon",className:"absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7",onClick:()=>A(""),children:e.jsx(we,{className:"h-4 w-4"})})]})]}),e.jsx(V,{children:e.jsx(_,{className:"p-0",children:R.length>0?e.jsxs(Se,{children:[e.jsx(De,{children:e.jsxs(Y,{children:[e.jsx(y,{children:"Agreement"}),e.jsx(y,{children:"Tenant"}),e.jsx(y,{children:"Shop"}),e.jsx(y,{children:"Duration"}),e.jsx(y,{className:"text-right",children:"Monthly Rent"}),e.jsx(y,{children:"Status"}),e.jsx(y,{className:"w-[100px]"})]})}),e.jsx(Ce,{children:R.map(s=>{var r,i,I;return e.jsxs(Y,{"data-testid":`row-lease-${s.id}`,children:[e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"font-mono text-sm",children:["LSE-",s.id.toString().padStart(4,"0")]})]})}),e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(J,{href:`/tenants/${s.tenantId}`,className:"hover:underline hover:text-primary cursor-pointer",children:(r=s.tenant)==null?void 0:r.name})]})}),e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium",children:["Shop ",(i=s.shop)==null?void 0:i.shopNumber]}),e.jsx("span",{className:"text-muted-foreground ml-2 text-sm",children:oe(((I=s.shop)==null?void 0:I.floor)||"")})]})]})}),e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(Te,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{children:[new Date(s.startDate).toLocaleDateString()," -"," ",new Date(s.endDate).toLocaleDateString()]})]})}),e.jsx(N,{className:"text-right tabular-nums font-medium",children:je(s.monthlyRent)}),e.jsx(N,{children:e.jsxs(qe,{className:Le(s.status),variant:"secondary",children:[s.status==="expiring_soon"&&e.jsx(O,{className:"h-3 w-3 mr-1"}),s.status.replace("_"," ")]})}),e.jsx(N,{children:e.jsx("div",{className:"flex items-center justify-end gap-1",children:e.jsx(J,{href:`/leases/${s.id}`,children:e.jsx(l,{variant:"ghost",size:"icon","data-testid":`button-view-lease-${s.id}`,children:e.jsx(ke,{className:"h-4 w-4"})})})})})]},s.id)})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(G,{className:"h-12 w-12 text-muted-foreground/50 mb-4"}),e.jsx("h3",{className:"font-semibold mb-1",children:"No leases found"}),e.jsx("p",{className:"text-muted-foreground text-sm mb-4",children:t==="all"?"Create your first lease agreement":`No ${t.replace("_"," ")} leases`}),t==="all"&&e.jsxs(l,{onClick:()=>S(!0),"data-testid":"button-add-first-lease",children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"New Lease"]})]})})})]})}export{Ye as default};
