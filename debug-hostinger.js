import fs from 'fs';
import path from 'path';
import http from 'http';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const LOG_FILE = 'debug_log.txt';

// Helper to load .env manually since we can't rely on dependencies
function loadEnv() {
    try {
        const envPath = path.resolve(process.cwd(), '.env');
        if (fs.existsSync(envPath)) {
            const content = fs.readFileSync(envPath, 'utf-8');
            content.split('\n').forEach(line => {
                const match = line.match(/^\s*([\w_]+)\s*=\s*(.*)?\s*$/);
                if (match) {
                    const key = match[1];
                    let value = match[2] || '';
                    if (value.length > 0 && value.charAt(0) === '"' && value.charAt(value.length - 1) === '"') {
                        value = value.replace(/\\n/gm, '\n');
                    }
                    value = value.replace(/(^['"]|['"]$)/g, '').trim();
                    if (!process.env[key]) {
                        process.env[key] = value;
                    }
                }
            });
            return true;
        }
    } catch (e) {
        console.error('Error loading .env:', e);
    }
    return false;
}

// Load env vars immediately
const envLoaded = loadEnv();

// Default to 3000 if PORT not set, but Hostinger usually sets PORT
const PORT = process.env.PORT || 3000;

function log(message) {
    const timestamp = new Date().toISOString();
    const logMessage = `[${timestamp}] ${message}`;
    console.log(logMessage);
    try {
        fs.appendFileSync(LOG_FILE, logMessage + '\n');
    } catch (e) {
        console.error('Failed to write to log file:', e);
    }
}

async function runDiagnostics() {
    log('=== Starting Hostinger Debug Diagnostics (ESM) ===');

    // 1. Environment Info
    log(`Node Version: ${process.version}`);
    log(`Platform: ${process.platform}`);
    log(`CWD: ${process.cwd()}`);
    // process.getuid is only available on POSIX platforms (Linux/macOS), not Windows
    if (process.platform !== 'win32' && process.getuid) {
        log(`UID: ${process.getuid()}`);
    } else {
        log(`UID: N/A (Windows)`);
    }

    // 2. File System Check
    const requiredFiles = [
        'package.json',
        'dist/index.cjs',
        '.env',
        'service-account.json',
        'node_modules'
    ];

    log('\n--- Checking Required Files ---');
    requiredFiles.forEach(file => {
        const filePath = path.resolve(process.cwd(), file);
        if (fs.existsSync(filePath)) {
            log(`[OK] ${file} exists`);
            if (file === 'dist/index.cjs') {
                try {
                    const stats = fs.statSync(filePath);
                    log(`    Size: ${stats.size} bytes`);
                } catch (e) {
                    log(`    [ERR] Could not stat file: ${e.message}`);
                }
            }
        } else {
            log(`[FAIL] ${file} MISSING`);
        }
    });

    // 3. Environment Variables
    log('\n--- Checking Environment Variables ---');
    if (envLoaded) {
        log('(Loaded variables from local .env file)');
    } else {
        log('(No local .env file loaded)');
    }

    const envVars = ['NODE_ENV', 'PORT', 'SESSION_SECRET'];
    envVars.forEach(v => {
        if (process.env[v]) {
            log(`[OK] ${v} is set (${v === 'PORT' || v === 'NODE_ENV' ? process.env[v] : '******'})`);
        } else {
            log(`[WARN] ${v} is NOT set`);
            if (v === 'PORT') log('    (Using default 3000)');
        }
    });

    log('\n=== Diagnostics Complete ===');
}

// Create HTTP Server
const server = http.createServer((req, res) => {
    log(`Incoming Request: ${req.method} ${req.url}`);

    if (req.url === '/debug-log.txt') {
        fs.readFile(LOG_FILE, (err, data) => {
            if (err) {
                res.writeHead(500, { 'Content-Type': 'text/plain' });
                res.end(`Error reading log file: ${err.message}`);
            } else {
                res.writeHead(200, { 'Content-Type': 'text/plain; charset=utf-8' });
                res.end(data);
            }
        });
    } else {
        res.writeHead(200, { 'Content-Type': 'text/html' });
        res.end(`
            <html>
                <head><title>Debug Info</title></head>
                <body style="font-family: monospace; padding: 20px;">
                    <h1>Configured as Debug Server (ESM)</h1>
                    <p>Status: Running</p>
                    <p><a href="/debug-log.txt">View Diagnostics Log</a></p>
                    <hr/>
                    <small>Generated by Agent</small>
                </body>
            </html>
        `);
    }
});

// Start Server and Run Diagnostics
server.listen(PORT, async () => {
    // Clear previous log on startup
    try {
        if (fs.existsSync(LOG_FILE)) fs.unlinkSync(LOG_FILE);
    } catch (e) { }

    log(`Debug Server (ESM) starting on port ${PORT}...`);
    await runDiagnostics();
});

server.on('error', (e) => {
    log(`[FATAL] Server error: ${e.message}`);
});
